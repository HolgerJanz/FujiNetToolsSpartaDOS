mads 2.0.9
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/FRESET.ASM
     1 				* FujiNet FRESET reset FujiNet
     2
     3 				        icl '_SYSEQU.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_SYSEQU.ICL
     1 = 0000			ICHID       equ $00
     2 = 0001			ICDNO       equ $01
     3 = 0002			ICCOM       equ $02
     4 = 0003			ICSTA       equ $03
     5 = 0004			ICBAL       equ $04
     6 = 0005			ICBAH       equ $05
     7 = 0006			ICPTL       equ $06
     8 = 0007			ICPTH       equ $07
     9 = 0008			ICBLL       equ $08
    10 = 0009			ICBLH       equ $09
    11 = 000A			ICAX1       equ $0A
    12 = 000B			ICAX2       equ $0B
    13 = 000C			ICAX3       equ $0C
    14 = 000D			ICAX4       equ $0D
    15 = 000E			ICAX5       equ $0E
    16 = 000F			ICAX6       equ $0F
    17
    18 = 000A			DOSVEC      equ $0A
    19 = 000C			DOSINI      equ $0C
    20 = 0012			RTCLOK      equ $12
    21 = 0042			CRITIC      equ $42
    22 = 006A			RAMTOP      equ $6a
    23
    24 = 02E4			RAMSIZ      equ $2e4
    25 = 02E5			MEMTOP      equ $2e5
    26 = 02E7			MEMLO       equ $2e7
    27 = 022F			SDMCTL      equ $22F
    28 = 02FC			CH          equ $2fc
    29
    30 = 0300			DDEVIC      equ $300
    31 = 0301			DUNIT       equ $301
    32 = 0302			DCMND       equ $302
    33 = 0303			DSTATS      equ $303
    34 = 0304			DBUFA       equ $304
    35 = 0306			DTIMLO      equ $306
    36 = 0307			DUNUSE      equ $307
    37 = 0308			DBYT        equ $308
    38 = 030A			DAUX1       equ $30A
    39 = 030B			DAUX2       equ $30B
    40
    41 = 0340			IOCB0       equ $340
    42
    43 				* dynamic SpartaDOS variables (relative to DOSVEC)
    44 = 0700			SD_SPARTA   equ $700 ; SpartaDOS flag 'S'
    45 = 0701			SD_SVERS    equ $701 ; SparataDOS version
    46 = 0702			SD_SSVERS   equ $702 ; SparataDOS sub version
    47 				* substract
    48 = 000A			SD_LSIO     equ $0A
    49 				* add
    50 = 0003			SD_CRNAME   equ $03
    51 = 0008			SD_XDIVIO   equ $08
    52 = 000A			SD_BUFOFF   equ $0a
    53 = 0013			SD_ODATER   equ $13
    54 = 0016			SD_OTIMER   equ $16
    55 = 0019			SD_TDOVER   equ $19
    56 = 003F			SD_LBUF     equ $3f
    57 = 0021			SD_COMFNAM  equ $21
    58
    59 = CFFF			AXLON       equ $CFFF
    60
    61 = D01F			CONSOL      equ $D01F
    62
    63 = D301			PORTB       equ $D301
    64
    65 = D400			DMACTL      equ $D400 
    66 = D40E			NMIEN       equ $D40E
    67
    68 = E456			CIOV        equ $E456
    69 = E474			WARMSV      equ $E474
    70 = E477			COLDSV      equ $E477
    71
    72 = FFEE			REVDAT      equ $ffee
    73 = FFF1			XLXEOP      equ $fff1
    74 = FFF2			PATNUM      equ $fff2
    75 = FFF7			REVNUM      equ $fff7
    76 = FFF8			CHKSUM      equ $fff8
     4 				        icl '_FNEQU.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_FNEQU.ICL
     1 				* CONFIG data length definition
     2 = 0021			fn_ssid_ln equ 33
     3 = 0040			fn_pass_ln equ 64
     4 = 0040			fn_host_ln equ 64
     5 = 0004			fn_ip_ln   equ 4
     6 = 0006			fn_mac_ln  equ 6
     7 = 000F			fn_firm_ln equ 15
     8 				* file name
     9 = 0024			fn_fnam_ln equ 36
    10 				* host slot
    11 = 0020			fn_hslt_ln equ 32
    12 = 0100			fn_hslt_l8 equ fn_hslt_ln*8
    13 				* device slot
    14 = 0026			fn_devs_ln equ 38
    15 = 0130			fn_devs_l8 equ fn_devs_ln*8
    16 				* WiFi Status 
    17 = 0000			WF_IDLE equ 0 ; WIFI is idle
    18 = 0001			WF_NOID equ 1 ; No SSID Available
    19 = 0002			WF_SCMP equ 2 ; Scan Completed
    20 = 0003			WF_CACT equ 3 ; Connected to network, and active
    21 = 0004			WF_CFLD equ 4 ; Last connect failed
    22 = 0005			WF_CLST equ 5 ; WiFi Connection Lost
    23 = 0006			WF_CDSC equ 6 ; WiFi explicitly disconnected
     5
     6 				        blk dos $3000
     7 FFFF> 3000-31AC> 20 9E +         jsr _chksdos
     8 3003 20 C2 30		        jsr _lbinit
     9 				* read config via SIO
    10 3006 A2 5B		        ldx <siorst
    11 3008 A0 30		        ldy >siorst
    12 300A 20 93 31		        jsr _dosio
    13 				* wait 4-5 sec
    14 300D A6 14		        ldx RTCLOK+2
    15 300F CA			        dex
    16 3010 E4 14		        cpx RTCLOK+2
    17 3012 D0 FC		        bne *-2
    18 3014 60			        rts
    19
    20 3015 20 67 30		prnDocu jsr _print
    21 3018 9B 55 73 61 67 65 +         dta b($9b),c'Usage: RESET',b($9b)
    22 3026			        icl '_VERSION.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_VERSION.ICL
     1 3026 56 65 72 73 69 6F +         dta c'Version: 21-03-23',b($9b)
    23 3038 52 65 73 65 74 73 +         dta c'Resets FujiNet and waits ca. 3s.',b($9b,$00)
    24 305A 60			        rts
    25
    26 				* DCB data for Fuji reset
    27 305B 70 01		siorst  dta b($70,$01)  ; FujiNet device and unit
    28 305D FF			        dta b($FF)      ; Command RESET
    29 305E 00			        dta b($00)      ; status
    30 305F 00 00		        dta a($0000)    ; address unused
    31 3061 10			        dta b($10)      ; time out
    32 3062 00			        dta b($00)      ; unused
    33 3063 00 00		        dta a($0000)    ; size unused
    34 3065 00			        dta b($00)      ; AUX1
    35 3066 00			        dta b($00)      ; AUX2
    36
    37 3067			        icl '_PRINT.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_PRINT.ICL
     1 				* print string to console
     2 3067 68			_print      pla
     3 3068 8D 78 30		            sta _print_lda+1
     4 306B 68			            pla
     5 306C 8D 79 30		            sta _print_lda+2
     6 306F EE 78 30		_print_loop inc _print_lda+1
     7 3072 D0 03		            bne _print_lda
     8 3074 EE 79 30		            inc _print_lda+2
     9 3077 AD FF FF		_print_lda  lda $FFFF
    10 307A F0 06		            beq _print_lend
    11 307C 20 8B 30		            jsr _putc
    12 307F 4C 6F 30		            jmp _print_loop
    13 3082 AD 79 30		_print_lend lda _print_lda+2
    14 3085 48			            pha
    15 3086 AD 78 30		            lda _print_lda+1
    16 3089 48			            pha
    17 308A 60			            rts
    18
    19 				* put char to console
    20 308B A8			_putc       tay
    21 308C A9 00		            lda #$00
    22 308E AA			            tax
    23 308F 9D 48 03		            sta $340+$08,X
    24 3092 9D 49 03		            sta $340+$09,X
    25 3095 A9 0B		            lda #$0B
    26 3097 9D 42 03		            sta $340+$02,X
    27 309A 98			            tya
    28 309B 4C 56 E4		            jmp $E456
    38 309E			        icl '_CHKSDOS.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_CHKSDOS.ICL
     1 309E AD 00 07		_chksdos    lda SD_SPARTA
     2 30A1 C9 53		            cmp #'S'
     3 30A3 F0 1C		            beq _chksdos_e
     4 30A5 20 67 30		            jsr _print
     5 30A8 9B			            dta b($9B)
     6 30A9 45 72 72 6F 72 3A +             dta c'Error: No SpartaDOS'
     7 30BC 9B 00		            dta b($9B,$00)
     8 30BE 6C 0A 00		            jmp (DOSVEC)
     9 30C1 60			_chksdos_e  rts
    39 30C2			        icl '_SDLBUF.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_SDLBUF.ICL
     1 				* iterator for LBUF parsing
     2 				* register X contains current offset
     3
     4 				* init iterartor
     5 30C2 18			_lbinit  clc
     6 30C3 A5 0A		         lda DOSVEC
     7 30C5 69 0A		         adc #SD_BUFOFF
     8 30C7 8D E1 30		         sta _bufoff+1
     9 30CA A5 0B		         lda DOSVEC+1
    10 30CC 69 00		         adc #$00
    11 30CE 8D E2 30		         sta _bufoff+2
    12 				* get LBUF
    13 30D1 18			         clc
    14 30D2 A5 0A		         lda DOSVEC
    15 30D4 69 3F		         adc #SD_LBUF
    16 30D6 8D FD 30		         sta _lbget+1
    17 30D9 A5 0B		         lda DOSVEC+1
    18 30DB 69 00		         adc #$00
    19 30DD 8D FE 30		         sta _lbget+2
    20 30E0 AD FF FF		_bufoff  lda $ffff
    21 30E3 48			         pha
    22 30E4 AA			         tax
    23 				* check for docu option /?
    24 30E5 20 01 31		         jsr _lbtrim
    25 30E8 C9 2F		         cmp #'/'
    26 30EA D0 0D		         bne _lbend
    27 30EC 20 FC 30		         jsr _lbget
    28 30EF C9 3F		         cmp #'?'
    29 30F1 D0 06		         bne _lbend
    30 30F3 20 15 30		         jsr prnDocu
    31 30F6 6C 0A 00		         jmp (DOSVEC)
    32 30F9 68			_lbend   pla
    33 30FA AA			         tax
    34 30FB 60			         rts
    35
    36 				* get next char from command line
    37 30FC BD FF FF		_lbget   lda $ffff,X
    38 30FF E8			         inx
    39 3100 60			         rts
    40
    41 				* trim spaces and get
    42 3101 20 FC 30		_lbtrim  jsr _lbget
    43 3104 C9 20		         cmp #' '
    44 3106 F0 F9		         beq *-5
    45 3108 60			         rts
    46
    40 3109			        icl '_SDFAIL.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_SDFAIL.ICL
     1 				* print error
     2 3109 98			_fail       tya
     3 310A 48			            pha
     4 310B 20 67 30		            jsr _print
     5 310E 9B			            dta b($9B)
     6 310F 45 72 72 6F 72 20	            dta c'Error '
     7 3115 00			            dta b($00)
     8 				* output error number in decimal
     9 3116 68			            pla
    10 3117 20 3B 31		            jsr _putdec
    11 311A A9 9B		            lda #$9B
    12 311C 20 8B 30		            jsr _putc
    13 				* check it is not SDX
    14 311F AD 01 07		            lda SD_SVERS
    15 3122 C9 40		            cmp #$40
    16 3124 B0 12		            bcs _dosvec
    17 				* stop batch for SpartaDOS 3
    18 3126 A0 08		            ldy #SD_XDIVIO
    19 3128 B1 0A		            lda (DOSVEC),Y
    20 312A 8D 36 31		            sta _fxdivio+1
    21 312D C8			            iny
    22 312E B1 0A		            lda (DOSVEC),Y
    23 3130 8D 37 31		            sta _fxdivio+2
    24 3133 A0 01		            ldy #$01
    25 3135 20 77 E4		_fxdivio    jsr COLDSV
    26 				* back home
    27 3138 6C 0A 00		_dosvec     jmp (DOSVEC)
    28
    29 313B A2 00		_putdec     ldx #$00
    30 313D 8E 72 31		            stx _chkprez
    31 3140 A2 02		            ldx #$02
    32 3142 A0 00		_dec_loop   ldy #$00
    33 3144 DD 73 31		_sbc_loop   cmp _decimal,X
    34 3147 90 06		            bcc _next_dec
    35 3149 FD 73 31		            sbc _decimal,X
    36 314C C8			            iny
    37 314D D0 F5		            bne _sbc_loop
    38 314F 48			_next_dec   pha
    39 3150 8A			            txa
    40 3151 48			            pha
    41 3152 98			            tya
    42 				* no leading zeros
    43 3153 0D 72 31		            ora _chkprez
    44 3156 8D 72 31		            sta _chkprez
    45 3159 F0 06		            beq *+8
    46 315B 98			            tya
    47 315C 09 30		            ora #$30
    48 315E 20 8B 30		            jsr _putc
    49 3161 68			            pla
    50 3162 AA			            tax
    51 3163 68			            pla
    52 3164 CA			            dex
    53 3165 10 DB		            bpl _dec_loop
    54 3167 AD 72 31		            lda _chkprez
    55 				* write 0 if all digit are zero
    56 316A D0 05		            bne *+7
    57 316C A9 30		            lda #'0'
    58 316E 20 8B 30		            jsr _putc
    59 3171 60			            rts
    60
    61 				* array with decimals
    62 3172 00			_chkprez    dta b($00)
    63 3173 01 0A 64		_decimal    dta b(1,10,100)
    41 3176			        icl '_SDLSIO.ICL'
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/FujiNetToolsSpartaDOS/SRC/_SDLSIO.ICL
     1 				* call local SD SIO
     2 3176 00			_lsioset    dta b($00)
     3 3177 AD 76 31		SD_SIO      lda _lsioset
     4 317A D0 14		            bne _jsr_lsio
     5 317C A5 0A		            lda DOSVEC
     6 317E 38			            sec
     7 317F E9 0A		            sbc #SD_LSIO
     8 3181 8D 91 31		            sta _jsr_lsio+1
     9 3184 A5 0B		            lda DOSVEC+1
    10 3186 E9 00		            sbc #$00
    11 3188 8D 92 31		            sta _jsr_lsio+2
    12 318B A9 FF		            lda #$ff
    13 318D 8D 76 31		            sta _lsioset
    14 3190 6C FF FF		_jsr_lsio   jmp ($ffff)
    15
    16 				* set DCB and call SIO
    17 3193 8E 9C 31		_dosio      stx _nxtsiod+1
    18 3196 8C 9D 31		            sty _nxtsiod+2
    19 3199 A2 0B		            ldx #$0b
    20 319B BD FF FF		_nxtsiod    lda $FFFF,X
    21 319E 9D 00 03		            sta DDEVIC,X
    22 31A1 CA			            dex
    23 31A2 10 F7		            bpl _nxtsiod
    24 31A4 20 77 31		            jsr SD_SIO
    25 31A7 10 03		            bpl *+5
    26 31A9 4C 09 31		            jmp _fail
    27 31AC 60			            rts
    42
    43 				        end
